<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metalsa G-Code Inteligente</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: #004b93; color: white; padding: 15px 40px; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .logo-container img { height: 40px; padding: 5px; border-radius: 4px; }
        header h1 { font-size: 20px; font-weight: 600; margin: 0; }

        /* --- LAYOUT --- */
        .main-container { flex: 1; display: flex; justify-content: center; padding: 40px 20px; }
        .card { background: white; width: 100%; max-width: 700px; padding: 40px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FORMUL√ÅRIO --- */
        h2 { margin-top: 0; color: #333; font-size: 22px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        input[type="file"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e1e4e8; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        input:focus { border-color: #004b93; outline: none; }

        /* --- RADIO BUTTONS --- */
        .radio-group { display: flex; gap: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .radio-label { display: flex; align-items: center; cursor: pointer; color: #555; }
        .radio-label input { margin-right: 10px; transform: scale(1.2); }

        /* --- TABELA --- */
        .table-responsive { max-height: 400px; overflow-y: auto; border: 1px solid #e1e4e8; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #f1f3f5; text-align: left; padding: 12px 15px; font-size: 14px; color: #555; position: sticky; top: 0; }
        td { padding: 10px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        td strong { color: #004b93; }
        td input[type="number"] { width: 80px; text-align: center; }

        /* --- BOT√ïES --- */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; color: white; margin-top: 15px; transition: 0.2s; }
        .btn-blue { background-color: #004b93; }
        .btn-blue:hover { background-color: #003870; }
        .btn-green { background-color: #28a745; }
        .btn-green:hover { background-color: #218838; }
        .btn-gray { background-color: #6c757d; }
        .btn-gray:hover { background-color: #5a6268; }

        .link-back { display: block; text-align: center; margin-top: 20px; color: #777; text-decoration: none; font-size: 14px; }

        /* --- VISUAL --- */
        .visual-container img { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; }
        .no-parts-warning { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/image_1.png') }}" alt="Logo Metalsa">
        </div>
        <h1>Editor G-Code Inteligente</h1>
    </header>

    <div class="main-container">

        {% if step == 'upload' %}
        <div class="card">
            <h2>üìÇ Passo 1: Carregar Arquivo</h2>
            <form action="/" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="arquivo">Selecione o arquivo .TAP</label>
                    <input type="file" name="arquivo" id="arquivo" required accept=".tap">
                </div>
                <div class="form-group" style="background: #e9ecef; padding: 15px; border-radius: 8px; font-size: 14px; color: #555;">
                    ‚ÑπÔ∏è O sistema ler√° o arquivo, identificar√° as pe√ßas e aplicar√° a l√≥gica de ciclo.
                </div>
                <button type="submit" name="acao" value="analisar" class="btn btn-blue">Analisar e Configurar ‚ûú</button>
            </form>
        </div>
        {% endif %}

        {% if step == 'config' %}
        <div class="card">
            <h2>‚öôÔ∏è Passo 2: Configurar Par√¢metros</h2>
            <form action="/" method="post">
                <textarea name="conteudo_oculto" style="display:none;">{{ conteudo }}</textarea>
                <input type="hidden" name="nome_arquivo_original" value="{{ nome_arquivo }}">

                <div class="form-group">
                    <label>Espessura da Chapa (Velocidade):</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="espessura" value="8mm" checked> <strong>8mm</strong> (F800)</label>
                        <label class="radio-label"><input type="radio" name="espessura" value="5mm"> <strong>5mm</strong> (F1000)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ciclo de Aplica√ß√£o por Pe√ßa:</label>
                    {% if not pecas or pecas[0] == "GENERICA" %}
                        <div class="no-parts-warning">‚ö† Pe√ßas n√£o identificadas. Regra ser√° geral.</div>
                    {% endif %}
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome da Pe√ßa</th>
                                    <th style="text-align: right; width: 140px;">Limite (Ciclo)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for peca in pecas %}
                                <tr>
                                    <td><strong>{{ peca }}</strong>{% if peca == "GENERICA" %}<br><small>(Geral)</small>{% endif %}</td>
                                    <td style="text-align: right;"><input type="number" name="limite_{{ peca }}" value="1" min="0"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <small style="color: #666; display: block; margin-top: 8px;">* L√≥gica: Altera X, Pula 1, Zera. √öltimo furo nunca altera.</small>
                </div>

                <button type="submit" name="acao" value="processar" class="btn btn-green">üíæ Processar e Baixar .TAP</button>
                <button type="submit" name="acao" value="visualizar" class="btn btn-gray">üëÅÔ∏è Apenas Visualizar Desenho</button>
                <a href="/" class="link-back">Cancelar e Voltar ao In√≠cio</a>
            </form>
        </div>
        {% endif %}

        {% if step == 'visual' %}
        <div class="card visual-container" style="text-align: center;">
            <h2>üëÅÔ∏è Visualiza√ß√£o do Caminho</h2>

            {% if preview_img %}
                <img src="data:image/png;base64,{{ preview_img }}" alt="Preview">
                <p style="color: #666; margin-top: 15px;">Visualiza√ß√£o XY (Superior). Arcos e retas simplificados.</p>
            {% else %}
                <p>Erro ao gerar a visualiza√ß√£o.</p>
            {% endif %}

            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                <form action="/" method="post" style="flex: 1; max-width: 300px;">
                    <textarea name="conteudo_oculto" style="display:none;">{{ conteudo }}</textarea>
                    <input type="hidden" name="nome_arquivo_original" value="{{ nome_arquivo }}">
                    <button type="submit" name="acao" value="reconfigurar" class="btn btn-gray">‚¨Ö Voltar e Configurar</button>
                </form>

                <a href="/" class="btn btn-blue" style="flex: 1; max-width: 300px; text-decoration: none;">üîÑ Novo Arquivo</a>
            </div>
        </div>
        {% endif %}

    </div>
</body>
</html>